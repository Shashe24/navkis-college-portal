<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HOD View</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>body { font-family: 'Inter', sans-serif; }</style>
  <script>
    function guard(){
      try {
        const role = localStorage.getItem('role');
        if(role !== 'hod'){
          window.location.replace('index.html');
        }
      } catch (e) {}
    }
    function applyContext(){
      const p = new URLSearchParams(window.location.search);
      const branch = p.get('branch');
      const year = p.get('year');
      const batch = p.get('batch');
      if(!branch || !year || !batch){
        window.location.replace('hod-select.html');
        return;
      }
      try {
        const hodBranch = localStorage.getItem('hodBranch');
        if(hodBranch && hodBranch !== branch){
          window.location.replace('hod-select.html');
          return;
        }
      } catch (e) {}
      const ctx = `${branch} • ${year} • ${batch}`;
      const el = document.getElementById('hod-context');
      if(el){ el.textContent = ctx; }
    }

    function calculateDashboardStats(students) {
      if (!students || students.length === 0) {
        return {
          totalStudents: 0,
          passedStudents: 0,
          failedStudents: 0,
          passingPercentage: 0,
          failingPercentage: 0,
          averageScore: 0,
          subjectStats: [],
          failedStudentsList: [],
          allStudents: []
        };
      }

      const totalStudents = students.length;
      let passedStudents = 0;
      let failedStudents = 0;
      let totalScore = 0;
      const subjectStats = {};
      const failedStudentsList = [];
      const allStudents = [];
      const topStudents = [];

      students.forEach(student => {
        // Get dynamic subjects from student data
        const subjects = Object.keys(student).filter(key => key !== 'student_name' && key !== 'student_id');
        const subjectMarks = subjects.map(subject => {
          const internal = parseInt(student[subject]?.internal || 0);
          const external = parseInt(student[subject]?.external || 0);
          const total = internal + external;
          const passed = external > 17; // Student passes only if external marks > 17
          return { subject, internal, external, total, passed };
        });

        const studentTotalScore = subjectMarks.reduce((sum, mark) => sum + mark.total, 0);
        const overallPercentage = studentTotalScore / (subjects.length * 100) * 100;
        const passedSubjects = subjectMarks.filter(mark => mark.passed).length;
        const failedSubjects = subjects.length - passedSubjects;

        totalScore += overallPercentage;

        // Determine if student passed overall (all subjects must have external > 17)
        const studentPassed = subjects.every(subject => parseInt(student[subject]?.external || 0) > 17);
        if (studentPassed) {
          passedStudents++;
        } else {
          failedStudents++;
          failedStudentsList.push({
            student_name: student.student_name,
            student_id: student.student_id,
            overallPercentage,
            failedSubjects
          });
        }

        // Add to all students list
        allStudents.push({
          student_name: student.student_name,
          student_id: student.student_id,
          overallPercentage,
          failedSubjects,
          passed: studentPassed
        });
        
        // Add to top students list
        topStudents.push({
          student_name: student.student_name,
          student_id: student.student_id,
          overallPercentage,
          passedSubjects,
          totalSubjects: subjects.length,
          failedSubjects,
          passed: studentPassed
        });

        // Calculate subject-wise stats
        subjectMarks.forEach(mark => {
          if (!subjectStats[mark.subject]) {
            subjectStats[mark.subject] = {
              name: mark.subject,
              passedCount: 0,
              failedCount: 0,
              totalCount: 0
            };
          }
          subjectStats[mark.subject].totalCount++;
          if (mark.passed) {
            subjectStats[mark.subject].passedCount++;
          } else {
            subjectStats[mark.subject].failedCount++;
          }
        });
      });

      // Convert subject stats to array and calculate percentages
      const subjectStatsArray = Object.values(subjectStats).map(stat => ({
        name: stat.name,
        passedCount: stat.passedCount,
        failedCount: stat.failedCount,
        totalCount: stat.totalCount,
        passPercentage: (stat.passedCount / stat.totalCount) * 100,
        failPercentage: (stat.failedCount / stat.totalCount) * 100
      }));

      // Sort top students by overall percentage (descending)
      const sortedTopStudents = topStudents.sort((a, b) => b.overallPercentage - a.overallPercentage);

      return {
        totalStudents,
        passedStudents,
        failedStudents,
        passingPercentage: (passedStudents / totalStudents) * 100,
        failingPercentage: (failedStudents / totalStudents) * 100,
        averageScore: totalScore / totalStudents,
        subjectStats: subjectStatsArray,
        failedStudentsList,
        allStudents,
        topStudents: sortedTopStudents
      };
    }

    function loadStudentData(){
      try {
        // Get HOD's branch from localStorage
        const hodBranch = localStorage.getItem('hodBranch');
        if (!hodBranch) {
          const container = document.getElementById('students-data');
          if (container) {
            container.innerHTML = '<p class="text-slate-500 text-center py-8">HOD branch not found. Please login again.</p>';
          }
          return;
        }

        const p = new URLSearchParams(window.location.search);
        const year = p.get('year');
        const batch = p.get('batch');
        
        // Debug: Log the received parameters

        
        if (!year || !batch) {
          const container = document.getElementById('students-data');
          if (container) {
            container.innerHTML = '<p class="text-slate-500 text-center py-8">Please select year and batch to view student data.</p>';
          }
          return;
        }
        
        // Look for admin student data for HOD's branch only
        const key = `admin_student_data_${hodBranch}_${year}_${batch}`;
        const adminData = localStorage.getItem(key);
        
        if (!adminData) {
          const container = document.getElementById('students-data');
          if (container) {
            container.innerHTML = '<p class="text-slate-500 text-center py-8">No student data available for your branch and this year.</p>';
          }
          return;
        }
        
        try {
          const parsed = JSON.parse(adminData);
          const students = parsed.students || [];
          
          if (students.length === 0) {
            const container = document.getElementById('students-data');
            if (container) {
              container.innerHTML = '<p class="text-slate-500 text-center py-8">No students found for your branch and this year.</p>';
            }
            return;
          }
          
          // Create analytics dashboard
          const container = document.getElementById('students-data');
          if (container) {
            // Store year and batch in variables accessible to the map function
            const currentYear = year;
            const currentBatch = batch;
            
            // Calculate analytics
            const analytics = calculateDashboardStats(students);
            
            container.innerHTML = `
              <!-- Analytics Dashboard -->
              <div class="space-y-12">
                <!-- Header Section -->
                <div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 rounded-xl p-6 text-white shadow-lg">
                  <div class="flex items-center justify-between">
                    <div>
                      <h2 class="text-2xl font-bold mb-2">Class Performance Dashboard</h2>
                      <p class="text-indigo-100 text-base">${hodBranch} • ${currentYear} • ${currentBatch}</p>
                      <p class="text-indigo-200 text-sm mt-1">Analytics and insights</p>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-xl p-4 backdrop-blur-sm">
                      <div class="text-center">
                        <div class="text-3xl font-bold">${analytics.passingPercentage.toFixed(1)}%</div>
                        <div class="text-indigo-100 text-sm">Class Passing %</div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Key Metrics Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-4 text-white shadow-sm">
                    <div class="flex items-center justify-between">
                      <div>
                        <p class="text-blue-100 text-xs font-medium">Total Students</p>
                        <p class="text-2xl font-bold">${analytics.totalStudents}</p>
                      </div>
                      <div class="bg-white bg-opacity-20 rounded-lg p-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                        </svg>
                      </div>
                    </div>
                  </div>
                  
                  <div class="bg-gradient-to-br from-emerald-500 to-green-600 rounded-lg p-4 text-white shadow-sm">
                    <div class="flex items-center justify-between">
                      <div>
                        <p class="text-green-100 text-xs font-medium">Passed</p>
                        <p class="text-2xl font-bold">${analytics.passedStudents}</p>
                        <p class="text-green-200 text-xs">${analytics.passingPercentage.toFixed(0)}%</p>
                      </div>
                      <div class="bg-white bg-opacity-20 rounded-lg p-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                      </div>
                    </div>
                  </div>
                  
                  <div class="bg-gradient-to-br from-red-500 to-rose-600 rounded-lg p-4 text-white shadow-sm">
                    <div class="flex items-center justify-between">
                      <div>
                        <p class="text-red-100 text-xs font-medium">Failed</p>
                        <p class="text-2xl font-bold">${analytics.failedStudents}</p>
                        <p class="text-red-200 text-xs">${analytics.failingPercentage.toFixed(0)}%</p>
                      </div>
                      <div class="bg-white bg-opacity-20 rounded-lg p-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                      </div>
                    </div>
                  </div>
                  
                  <div class="bg-gradient-to-br from-purple-500 to-violet-600 rounded-lg p-4 text-white shadow-sm">
                    <div class="flex items-center justify-between">
                      <div>
                        <p class="text-purple-100 text-xs font-medium">Average</p>
                        <p class="text-2xl font-bold">${analytics.averageScore.toFixed(0)}%</p>
                      </div>
                      <div class="bg-white bg-opacity-20 rounded-lg p-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
                        </svg>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Subject-wise Analysis -->
                <div class="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                  <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold text-slate-800">Subject Performance</h3>
                    <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-medium">
                      ${analytics.subjectStats.length} Subjects
                    </div>
                  </div>
                  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                    ${analytics.subjectStats.map(subject => `
                      <div class="bg-slate-50 rounded-lg p-3 border border-slate-100 hover:bg-slate-100 transition-colors">
                        <div class="flex justify-between items-center mb-2">
                          <h4 class="font-medium text-slate-800 text-sm">${subject.name.charAt(0).toUpperCase() + subject.name.slice(1)}</h4>
                          <span class="text-xs text-slate-500">${subject.passedCount}/${analytics.totalStudents}</span>
                        </div>
                        <div class="mb-2">
                          <div class="w-full bg-slate-200 rounded-full h-1.5">
                            <div class="bg-gradient-to-r from-emerald-400 to-green-500 h-1.5 rounded-full transition-all duration-500" style="width: ${subject.passPercentage}%"></div>
                          </div>
                        </div>
                        <div class="flex justify-between text-xs">
                          <span class="text-green-600 font-medium">${subject.passPercentage.toFixed(0)}% Pass</span>
                          <span class="text-red-500 font-medium">${subject.failPercentage.toFixed(0)}% Fail</span>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
                
                <!-- Top 5 Students -->
                <div class="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                  <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold text-slate-800">Top 5 Performers</h3>
                    <div class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs font-medium">
                      Best Results
                    </div>
                  </div>
                  ${analytics.topStudents && analytics.topStudents.length > 0 ? `
                    <div class="space-y-3">
                      ${analytics.topStudents.slice(0, 5).map((student, index) => `
                        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-200 rounded-lg p-3 hover:bg-yellow-100 transition-colors">
                          <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                              <div class="w-8 h-8 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center">
                                <span class="text-white font-bold text-sm">${index + 1}</span>
                              </div>
                              <div>
                                <h4 class="font-medium text-slate-900 text-sm">${student.student_name}</h4>
                                <p class="text-slate-600 text-xs">ID: ${student.student_id} • ${student.overallPercentage.toFixed(0)}%</p>
                              </div>
                            </div>
                            <div class="flex items-center space-x-2">
                              <div class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs font-medium">
                                ${student.passedSubjects}/${student.totalSubjects} Passed
                              </div>
                              <button onclick="showStudentResultSheet('${student.student_id}', '${student.student_name}')" 
                                      class="bg-yellow-600 text-white px-2 py-1 rounded text-xs font-medium hover:bg-yellow-700 transition-colors">
                                View
                              </button>

                            </div>
                          </div>
                        </div>
                      `).join('')}
                    </div>
                  ` : `
                    <div class="text-center py-6">
                      <div class="w-12 h-12 bg-yellow-500 rounded-full flex items-center justify-center mx-auto mb-3">
                        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                      </div>
                      <h4 class="text-lg font-semibold text-slate-900 mb-2">No Top Performers Yet</h4>
                      <p class="text-slate-600 text-sm">Students need to be added to see top performers</p>
                    </div>
                  `}
                </div>
                
                <!-- Failed Students List -->
                <div class="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                  <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold text-slate-800">Failed Students</h3>
                    <div class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-medium">
                      ${analytics.failedStudents} Students
                    </div>
                  </div>
                  ${analytics.failedStudents > 0 ? `
                    <div class="space-y-3">
                      ${analytics.failedStudentsList.map(student => `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-3 hover:bg-red-100 transition-colors">
                          <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                              <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center">
                                <span class="text-white font-bold text-sm">${student.student_name.charAt(0)}</span>
                              </div>
                              <div>
                                <h4 class="font-medium text-slate-900 text-sm">${student.student_name}</h4>
                                <p class="text-slate-600 text-xs">ID: ${student.student_id} • ${student.overallPercentage.toFixed(0)}%</p>
                              </div>
                            </div>
                            <div class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs font-medium">
                              ${student.failedSubjects} Failed
                            </div>
                          </div>
                        </div>
                      `).join('')}
                    </div>
                  ` : `
                    <div class="text-center py-6">
                      <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-3">
                        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                      </div>
                      <h4 class="text-lg font-semibold text-slate-900 mb-2">All Students Passed!</h4>
                      <p class="text-slate-600 text-sm">No support needed</p>
                    </div>
                  `}
                </div>
                
                <!-- All Students Summary -->
                <div class="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                  <div class="flex items-center justify-between mb-3">
                    <div>
                      <h3 class="text-lg font-semibold text-slate-800">Student Database</h3>
                      <div class="flex items-center gap-2 mt-1">
                        <span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded text-xs font-medium">${hodBranch}</span>
                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium">${currentYear}</span>
                        <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs font-medium">${currentBatch}</span>
                      </div>
                    </div>
                    <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-medium">
                      ${analytics.totalStudents} Students
                    </div>
                  </div>
                  <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                      <thead class="bg-slate-50 rounded-lg">
                        <tr>
                          <th class="px-3 py-2 text-left font-medium text-slate-700 text-xs">Student Name</th>
                          <th class="px-3 py-2 text-left font-medium text-slate-700 text-xs">Student ID</th>
                          <th class="px-3 py-2 text-center font-medium text-slate-700 text-xs">Overall Score</th>
                          <th class="px-3 py-2 text-center font-medium text-slate-700 text-xs">Pass/Fail</th>
                          <th class="px-3 py-2 text-center font-medium text-slate-700 text-xs">Failed Subjects</th>
                          <th class="px-3 py-2 text-center font-medium text-slate-700 text-xs">View Result</th>
                        </tr>
                        <tr class="bg-slate-100">
                          <td colspan="6" class="px-3 py-1 text-center text-xs text-slate-600 font-medium">
                            Database: ${hodBranch} Branch • ${currentYear} • ${currentBatch} Batch
                          </td>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-slate-200">
                        ${analytics.allStudents.map(student => `
                          <tr class="hover:bg-slate-50 transition-colors">
                            <td class="px-3 py-2 font-medium text-slate-900 text-sm">${student.student_name}</td>
                            <td class="px-3 py-2 text-slate-600 text-xs">${student.student_id}</td>
                            <td class="px-3 py-2 text-center">
                              <div class="inline-flex items-center px-2 py-1 rounded text-xs font-medium ${student.overallPercentage >= 80 ? 'bg-green-100 text-green-800' : student.overallPercentage >= 60 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                ${student.overallPercentage.toFixed(0)}%
                              </div>
                            </td>
                            <td class="px-3 py-2 text-center">
                              <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium ${student.failedSubjects > 0 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                ${student.failedSubjects > 0 ? 'Failed' : 'Passed'}
                              </span>
                            </td>
                            <td class="px-3 py-2 text-center">
                              <div class="inline-flex items-center px-2 py-1 rounded text-xs font-medium ${student.failedSubjects > 0 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                ${student.failedSubjects}
                              </div>
                            </td>
                            <td class="px-3 py-2 text-center">
                              <button onclick="showStudentResultSheet('${student.student_id}', '${student.student_name}')" 
                                      class="bg-indigo-600 text-white px-3 py-1 rounded text-xs font-medium hover:bg-indigo-700 transition-colors">
                                View
                              </button>
                            </td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            `;
          }
        } catch (e) {
          console.error('Error parsing admin data:', e);
          const container = document.getElementById('students-data');
          if (container) {
            container.innerHTML = '<p class="text-slate-500 text-center py-8">Error loading student data.</p>';
          }
        }
      } catch (e) {
        console.error('Error loading student data:', e);
        const container = document.getElementById('students-data');
        if (container) {
          container.innerHTML = '<p class="text-slate-500 text-center py-8">Error loading student data.</p>';
        }
      }
    }

    function viewStudentDetail(studentId, studentName) {
      // Show detailed student view
      document.getElementById('students-overview-section').style.display = 'none';
      document.getElementById('student-detail-section').style.display = 'block';
      
      // Load detailed student data
      loadStudentDetail(studentId, studentName);
    }

    function backToOverview() {
      // Show overview section
      document.getElementById('students-overview-section').style.display = 'block';
      document.getElementById('student-detail-section').style.display = 'none';
    }

    function showStudentResultSheet(studentId, studentName) {
      try {
        // Show loading modal first
        const loadingModal = document.createElement('div');
        loadingModal.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[9999]';
        loadingModal.innerHTML = `
          <div class="bg-white rounded-xl p-8 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <p class="text-slate-600 font-medium">Loading Result Sheet...</p>
            <p class="text-slate-500 text-sm mt-1">${studentName}</p>
          </div>
        `;
        document.body.appendChild(loadingModal);
        
        // Get current context - use HOD branch from localStorage
        const hodBranch = localStorage.getItem('hodBranch');
        const urlParams = new URLSearchParams(window.location.search);
        const year = urlParams.get('year');
        const batch = urlParams.get('batch');
        

        
        // Load student data - try multiple batch formats
        let dataKey = `admin_student_data_${hodBranch}_${year}_${batch}`;

        
        let allStudentsData = JSON.parse(localStorage.getItem(dataKey) || '[]');
        
        // If no data found, try alternative batch formats
        if (allStudentsData.length === 0) {
          const alternativeBatches = [
            `_${year}_${batch}`,
            `_${year}_2023-2027`,
            `_${year}_2024-2028`,
            `_${year}_2025-2029`
          ];
          
          for (const altBatch of alternativeBatches) {
            const altKey = `admin_student_data_${hodBranch}${altBatch}`;

            const altData = JSON.parse(localStorage.getItem(altKey) || '[]');
            if (altData.length > 0) {
              allStudentsData = altData;
              dataKey = altKey;

              break;
            }
          }
        }
        
        // If still no data, try to find from admin data structure
        if (allStudentsData.length === 0) {
          const adminData = JSON.parse(localStorage.getItem(dataKey) || '{}');
          if (adminData && adminData.students) {
            allStudentsData = adminData.students;

          }
        }
        

        
        // Find the specific student
        const student = allStudentsData.find(s => s.student_id === studentId);
        
        if (!student) {
          console.error('Student not found:', {
            studentId,
            availableStudents: allStudentsData.map(s => s.student_id)
          });
          alert(`Student data not found for ID: ${studentId}\nAvailable students: ${allStudentsData.map(s => s.student_id).join(', ')}`);
          return;
        }
        

        
        // Get subjects dynamically
        const subjects = Object.keys(student).filter(key => 
          key !== 'student_name' && key !== 'student_id'
        );
        
        // Calculate totals
        let totalMarks = 0;
        let maxMarks = subjects.length * 100; // Each subject has 100 max marks
        
        subjects.forEach(subject => {
          const internal = parseFloat(student[subject]?.internal || 0);
          const external = parseFloat(student[subject]?.external || 0);
          totalMarks += internal + external;
        });
        
        const percentage = ((totalMarks / maxMarks) * 100).toFixed(1);
        
        // Create detailed result sheet modal
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[9999] p-4';
        modal.style.backdropFilter = 'blur(4px)';
        
        // Add click outside to close functionality
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            modal.remove();
          }
        });
        
        // Add ESC key to close functionality
        const handleEscKey = function(e) {
          if (e.key === 'Escape') {
            modal.remove();
            document.removeEventListener('keydown', handleEscKey);
          }
        };
        document.addEventListener('keydown', handleEscKey);
        
        modal.innerHTML = `
          <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <!-- Header -->
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 rounded-t-xl">
              <div class="flex items-center justify-between">
                <div>
                  <h2 class="text-2xl font-bold">Student Result Sheet</h2>
                  <p class="text-indigo-100 mt-1">${hodBranch} • ${year} • ${batch}</p>
                </div>
                <button onclick="this.closest('.fixed').remove()" 
                        class="text-white hover:text-gray-200 text-2xl font-bold">
                  ×
                </button>
              </div>
            </div>
            
            <!-- Student Info -->
            <div class="p-6 border-b border-gray-200">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                  <h3 class="font-semibold text-blue-800 text-sm">Student Name</h3>
                  <p class="text-blue-900 text-lg font-bold">${student.student_name}</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                  <h3 class="font-semibold text-green-800 text-sm">Student ID</h3>
                  <p class="text-green-900 text-lg font-bold">${student.student_id}</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                  <h3 class="font-semibold text-purple-800 text-sm">Overall Percentage</h3>
                  <p class="text-purple-900 text-2xl font-bold">${percentage}%</p>
                </div>
              </div>
            </div>
            
            <!-- Subject-wise Results -->
            <div class="p-6">
              <h3 class="text-xl font-bold text-gray-800 mb-4">Subject-wise Performance</h3>
              <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                  <thead>
                    <tr class="bg-gray-50">
                      <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Subject</th>
                      <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-gray-700">Internal</th>
                      <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-gray-700">External</th>
                      <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-gray-700">Total</th>
                      <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-gray-700">Percentage</th>
                      <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-gray-700">Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${subjects.map(subject => {
                      const internal = parseFloat(student[subject]?.internal || 0);
                      const external = parseFloat(student[subject]?.external || 0);
                      const total = internal + external;
                      const subjectPercentage = ((total / 100) * 100).toFixed(1);
                      const isPassed = external > 17; // Student passes only if external marks > 17
                      
                      return `
                        <tr class="hover:bg-gray-50">
                          <td class="border border-gray-300 px-4 py-3 font-medium text-gray-900">${subject}</td>
                          <td class="border border-gray-300 px-4 py-3 text-center">${internal}</td>
                          <td class="border border-gray-300 px-4 py-3 text-center">${external}</td>
                          <td class="border border-gray-300 px-4 py-3 text-center font-semibold">${total}</td>
                          <td class="border border-gray-300 px-4 py-3 text-center">${subjectPercentage}%</td>
                          <td class="border border-gray-300 px-4 py-3 text-center">
                            <span class="px-3 py-1 rounded-full text-sm font-medium ${isPassed ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                              ${isPassed ? 'PASS' : 'FAIL'}
                            </span>
                          </td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- Summary -->
            <div class="p-6 bg-gray-50 rounded-b-xl">
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded-lg text-center">
                  <h4 class="text-sm font-semibold text-gray-600">Total Marks</h4>
                  <p class="text-2xl font-bold text-gray-900">${totalMarks}</p>
                </div>
                <div class="bg-white p-4 rounded-lg text-center">
                  <h4 class="text-sm font-semibold text-gray-600">Max Marks</h4>
                  <p class="text-2xl font-bold text-gray-900">${maxMarks}</p>
                </div>
                <div class="bg-white p-4 rounded-lg text-center">
                  <h4 class="text-sm font-semibold text-gray-600">Overall %</h4>
                  <p class="text-2xl font-bold text-gray-900">${percentage}%</p>
                </div>
                <div class="bg-white p-4 rounded-lg text-center">
                  <h4 class="text-sm font-semibold text-gray-600">Final Status</h4>
                  <p class="text-2xl font-bold ${subjects.every(subject => parseFloat(student[subject]?.external || 0) > 17) ? 'text-green-600' : 'text-red-600'}">
                    ${subjects.every(subject => parseFloat(student[subject]?.external || 0) > 17) ? 'PASS' : 'FAIL'}
                  </p>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Remove loading modal and add result sheet modal
        document.body.removeChild(loadingModal);
        document.body.appendChild(modal);
        
      } catch (error) {
        console.error('Error showing student result sheet:', error);
        // Remove loading modal if it exists
        const existingLoadingModal = document.querySelector('.fixed.inset-0.bg-black');
        if (existingLoadingModal) {
          document.body.removeChild(existingLoadingModal);
        }
        alert('Error loading student result sheet!');
      }
    }

    function loadStudentDetail(studentId, studentName) {
      const hodBranch = localStorage.getItem('hodBranch');
      const p = new URLSearchParams(window.location.search);
      const year = p.get('year');
      const batch = p.get('batch');
      
      // Find student data
      const key = `admin_student_data_${hodBranch}_${year}_${batch}`;
      const adminData = localStorage.getItem(key);
      
      if (!adminData) return;
      
      try {
        const parsed = JSON.parse(adminData);
        const student = parsed.students.find(s => s.student_id === studentId);
        
        if (!student) return;
        
        // Display detailed student information
        const container = document.getElementById('student-detail-container');
        if (container) {
          const subjects = Object.keys(student).filter(key => key !== 'student_name' && key !== 'student_id');
          const subjectMarks = subjects.map(subject => {
            const internal = parseInt(student[subject]?.internal || 0);
            const external = parseInt(student[subject]?.external || 0);
            const total = internal + external;
            const passed = total >= 60;
            return { subject, internal, external, total, passed };
          });
          
          const totalScore = subjectMarks.reduce((sum, mark) => sum + mark.total, 0);
          const overallPercentage = totalScore / (subjects.length * 100) * 100;
          const passedSubjects = subjectMarks.filter(mark => mark.passed).length;
          const failedSubjects = subjects.length - passedSubjects;
          
          container.innerHTML = `
            <div class="bg-white rounded-lg border border-slate-200 p-6">
              <div class="flex justify-between items-start mb-6">
                <div>
                  <h2 class="text-2xl font-bold text-slate-900">${studentName}</h2>
                  <p class="text-slate-600">Student ID: ${studentId}</p>
                  <p class="text-slate-600">Branch: ${hodBranch} • Year: ${year}</p>
                </div>
                <div class="text-right">
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${failedSubjects > 0 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                    ${failedSubjects} Failed Subject${failedSubjects !== 1 ? 's' : ''}
                  </span>
                </div>
              </div>
              
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="text-center p-4 bg-slate-50 rounded-lg">
                  <div class="text-slate-500 text-xs">Overall Percentage</div>
                  <div class="text-2xl font-bold text-slate-900">${overallPercentage.toFixed(1)}%</div>
                </div>
                <div class="text-center p-4 bg-slate-50 rounded-lg">
                  <div class="text-slate-500 text-xs">Total Score</div>
                  <div class="text-2xl font-bold text-slate-900">${totalScore}/${subjects.length * 100}</div>
                </div>
                <div class="text-center p-4 bg-slate-50 rounded-lg">
                  <div class="text-slate-500 text-xs">Passed Subjects</div>
                  <div class="text-2xl font-bold text-slate-900">${passedSubjects}</div>
                </div>
                <div class="text-center p-4 bg-slate-50 rounded-lg">
                  <div class="text-slate-500 text-xs">Failed Subjects</div>
                  <div class="text-2xl font-bold text-slate-900">${failedSubjects}</div>
                </div>
              </div>
              
              <div class="mb-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">Detailed Subject Analysis</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                  ${subjectMarks.map(mark => `
                    <div class="p-4 bg-slate-50 rounded-lg text-center">
                      <h4 class="font-semibold text-slate-800 mb-2">${mark.subject.charAt(0).toUpperCase() + mark.subject.slice(1)}</h4>
                      <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                          <span class="text-slate-600">Internal:</span>
                          <span class="font-medium">${mark.internal}/50</span>
                        </div>
                        <div class="flex justify-between">
                          <span class="text-slate-600">External:</span>
                          <span class="font-medium">${mark.external}/50</span>
                        </div>
                        <div class="pt-2 border-t border-slate-200">
                          <div class="font-bold text-lg ${mark.passed ? 'text-green-600' : 'text-red-600'}">${mark.total}/100</div>
                          <div class="text-xs ${mark.passed ? 'text-green-600' : 'text-red-600'}">${mark.passed ? 'PASSED' : 'FAILED'}</div>
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          `;
        }
      } catch (e) {
        console.error('Error loading student detail:', e);
      }
    }

    document.addEventListener('DOMContentLoaded', function(){
      guard();
      applyContext();
      loadStudentData();
    });
  </script>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">
  <header class="bg-white border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-6 py-6 flex items-center justify-between">
      <h1 class="text-xl font-bold text-slate-900">HOD Dashboard</h1>
      <div class="space-x-4 text-sm">
        <a href="index.html" class="text-slate-600 hover:underline">Switch Role</a>
        <a href="login-hod.html" class="text-blue-600 hover:underline">Logout</a>
      </div>
    </div>
  </header>
  <main class="max-w-full mx-auto px-4 md:px-8 py-8">
    <div class="max-w-full mx-auto mb-6 text-slate-600 text-lg">Viewing: <span id="hod-context" class="font-bold text-slate-800 text-xl"></span></div>
    
    <!-- Students Overview Section -->
    <section id="students-overview-section" class="bg-white rounded-2xl shadow-lg border border-slate-100 mb-8">
      <div class="p-8 border-b border-slate-100">
        <div class="flex justify-between items-center">
          <div>
            <h2 class="text-slate-900 font-bold text-2xl">Student Results Dashboard</h2>
            <p class="text-slate-600 text-lg mt-2">Academic performance and subject-wise marks from admin portal (${localStorage.getItem('hodBranch') || 'Your Branch'} students only)</p>
          </div>
          <button onclick="loadStudentData()" class="bg-blue-600 text-white text-sm rounded-lg px-4 py-2 hover:bg-blue-700">
            Refresh Data
          </button>
        </div>
      </div>
      <div class="p-8">
        <div id="students-data" class="w-full">
          <!-- Student data will be loaded here -->
        </div>
      </div>
    </section>

    <!-- Student Detail Section -->
    <section id="student-detail-section" class="bg-white rounded-2xl shadow-lg border border-slate-100 mb-8" style="display: none;">
      <div class="p-6 border-b border-slate-100">
        <div class="flex justify-between items-center">
      <div>
            <h2 class="text-slate-900 font-bold text-lg">Student Detailed Results</h2>
            <p class="text-slate-600 text-sm mt-1">Comprehensive analysis of individual student performance</p>
          </div>
          <button onclick="backToOverview()" class="bg-slate-600 text-white text-sm rounded-lg px-4 py-2 hover:bg-slate-700">
            ← Back to Overview
          </button>
        </div>
      </div>
      <div class="p-6">
        <div id="student-detail-container">
          <!-- Detailed student data will be loaded here -->
        </div>
      </div>
    </section>

  </main>
</body>
</html>



